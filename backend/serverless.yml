service: dentacare-backend
frameworkVersion: '3'
useDotenv: true

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}
  environment:
    USER_POOL_ID: { Ref: CognitoUserPool }
    USER_POOL_CLIENT_ID: { Ref: CognitoUserPoolClient }
    USERS_TABLE: ${self:custom.usersTableName}
    UPLOAD_BUCKET: ${self:custom.uploadBucketName}
    APPOINTMENTS_TABLE: ${self:custom.appointmentsTableName}
    CONTACTS_TABLE: ${self:custom.contactsTableName}
    JWT_SECRET: ${env:JWT_SECRET}

plugins:
  - serverless-dotenv-plugin
  - serverless-iam-roles-per-function

custom:
  usersTableName: ${self:service}-${self:provider.stage}-users
  uploadBucketName: ${self:service}-${self:provider.stage}-uploads-${aws:accountId}
  appointmentsTableName: ${self:service}-${self:provider.stage}-appointments
  contactsTableName: ${self:service}-${self:provider.stage}-contacts

functions:
  signup:
    handler: src/handlers/auth.signup
    events:
      - http:
          path: signup
          method: post
          cors: true
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - cognito-idp:SignUp
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.usersTableName}
          - arn:aws:cognito-idp:${self:provider.region}:${aws:accountId}:userpool/*

  login:
    handler: src/handlers/auth.login
    events:
      - http:
          path: login
          method: post
          cors: true
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - cognito-idp:InitiateAuth
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.usersTableName}
          - arn:aws:cognito-idp:${self:provider.region}:${aws:accountId}:userpool/*

  confirm:
    handler: src/handlers/auth.confirm
    events:
      - http:
          path: confirm
          method: post
          cors: true
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ConfirmSignUp
        Resource:
          - arn:aws:cognito-idp:${self:provider.region}:${aws:accountId}:userpool/*

  upload:
    handler: src/handlers/upload.handleUpload
    events:
      - http:
          path: upload
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt: [CognitoUserPool, Arn]
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource:
          - arn:aws:s3:::${self:custom.uploadBucketName}/*

  jwtAuthorizer:
    handler: src/handlers/auth.jwtAuthorizer
    iamRoleStatements: []

  root:
    handler: src/handlers/root.handle
    events:
      - http:
          path: /
          method: any
          cors: true
      - http:
          path: '{proxy+}'
          method: any
          cors: true
    iamRoleStatements: []

  listAppointments:
    handler: src/handlers/appointments.list
    events:
      - http:
          path: appointments
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt: [CognitoUserPool, Arn]
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.appointmentsTableName}

  createAppointment:
    handler: src/handlers/appointments.create
    events:
      - http:
          path: appointments
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt: [CognitoUserPool, Arn]
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:Scan
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.appointmentsTableName}

  deleteAppointment:
    handler: src/handlers/appointments.remove
    events:
      - http:
          path: appointments/{id}
          method: delete
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt: [CognitoUserPool, Arn]
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.appointmentsTableName}

  contactSubmit:
    handler: src/handlers/contact.submit
    events:
      - http:
          path: contact
          method: post
          cors: true
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.contactsTableName}

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.usersTableName}
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    UploadBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.uploadBucketName}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedHeaders:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
              MaxAge: 3000
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    AppointmentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.appointmentsTableName}
        AttributeDefinitions:
          - AttributeName: userEmail
            AttributeType: S
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: userEmail
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    ContactsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.contactsTableName}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${self:provider.stage}-user-pool
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: true
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-${self:provider.stage}-web
        UserPoolId: { Ref: CognitoUserPool }
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        PreventUserExistenceErrors: ENABLED
        SupportedIdentityProviders:
          - COGNITO

  Outputs:
    UsersTableName:
      Value: ${self:custom.usersTableName}
    UploadBucketName:
      Value: ${self:custom.uploadBucketName}
    CognitoUserPoolId:
      Value: { Ref: CognitoUserPool }
    CognitoUserPoolClientId:
      Value: { Ref: CognitoUserPoolClient }
